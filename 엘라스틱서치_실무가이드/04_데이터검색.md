# 데이터 검색
- 엘라스틱서치는 인덱스에 저장된 문서를 검색할 수 있도록 다양한 검색 기능 제공.
- 문서는 색인시 설정한 분석기에 의해 분석 과정을 거쳐 토큰으로 분리, 이러한 분석기는 색인 시첨에 사용할 수도 있지만 검색 시점에 사용하는 것도 가능
- 특정 문장이 검색어로 요청 -> 분석기를 통해 분석된 토큰의 일치 여부 판단 -> 결과에 점수 매김 -> 순서를 적용해 사용자에게 결과 출력
- 검색의 대상이 되는 필드는 분석이 되는 Text 타입의 유형일수도, 분석이 되지 않는 Keyword 타입의 유형일수도 있다.
- 검색조건을 충족시키기 위해 Query DSL이라는 특수한 쿼리 문법 제공

## 4.1 검색 API
- 문장은 색인 시점에 텀으로 분해. 
- 검색 시에는 이 텀을 일치시켜야 검색이 가능(색인 시점에 생성한 텀 -> 검색 시점에 찾는 방법?)
- 그림 4.1 색인 시점과 검색 시점에서의 동작 방식 비교
![형태소 분석 프로세스](/image/img_7.png)
- 엘라스틱서치는 색인 시첨에 Analyzer를 통해 분석된 텀을 Term, 출현빈도, 문서번호와 같이 역색인 구조로 만들어 내부적으로 저장
- 검색 시점에는 검색 불가능 Keyword 타입과 검색 가능 Text 타입과 같은 데이터를 구분해서 분석이 가능할 경우 분석기를 이용해 분석 수행
- 검색 시점에도 그래서 텀을 얻을 수 있고, 해당 텀으로 역색인 구조를 이용해 문서를 찾고 이를 통해 스코어를 꼐산해서 결과로 제공
- 이러한 동작 방식을 이해하고 이에 맞춰 목적에 맞게 검색 쿼리를 사용해야 한다.
- movie_search 인덱스를 복구해야 한다. 
~~~
curl -XGET 'http://localhost:9200/_snapshot/javacafe/_all?pretty'
~~~
- javacafe 스냅숏 그룹 내부에는 다음과 같이 1개의 스냅숏이 존재
~~~
{
    "snapshots": [
        {
            "snapshot": "movie-search",
            "uuid": "Kz5k4fusS7KBZy55wLeZ0Q",
            "repository": "javacafe",
            "version_id": 6040399,
            "version": "6.4.3",
            "indices": [
                "movie_search"
            ],
            "data_streams": [],
            "include_global_state": false,
            "state": "SUCCESS",
            "start_time": "2019-03-23T16:01:04.910Z",
            "start_time_in_millis": 1553356864910,
            "end_time": "2019-03-23T16:01:05.342Z",
            "end_time_in_millis": 1553356865342,
            "duration_in_millis": 432,
            "failures": [],
            "shards": {
                "total": 5,
                "failed": 0,
                "successful": 5
            },
            "feature_states": []
        }
    ],
    "total": 1,
    "remaining": 0
}
~~~
- movie-search 스냅숏 복구
~~~
curl -XPOST 'http://localhost:9200/_snapshot/javacafe/movie-search/_restore'
~~~

~~~
GET /_cat/indices/movie_search?v&pretty

health status index        uuid                   pri rep docs.count docs.deleted store.size pri.store.size
yellow open   movie_search 5halU0ozTYOwiH647DkA7Q   5   1          63069            0        1kb            1kb
~~~

### 4.1.1 검색 질의 표현 방식
- API는 기본적으로 쿼리 기반 동작
- 동일한 조건을 다음과 같은 두 가지 방식으로 표현할 수 있다
  - URI 검색
  - Request Body 검색
- 첫번째는 루씬에서 사용하던 전통적은 방식의 URI 표기법. 두 번째는 RESTful API를 이용해 표현
- URI 검색
  - Key=Value 형태로 전달
  - 파라미터로 표현할 수 있는 표현의 한계로 복잡한 질의 작성 불가
  - ex)
~~~
GET movie_search/_search?q=prdtYear:2018
~~~
- Request Body
  - JSON 형태로 표현해서 전달.
  - Query DSL이라는 특별한 문법 지원
  - 엘라스틱서치 제공 검색 API를 모두 활용하려면 Request Body 방식이 필요하다.
  - ex)
~~~
PUT movie_search/_search
{
    "query" : {
        "term" : { "prdtYear" : 2018 }
    }
}
~~~




